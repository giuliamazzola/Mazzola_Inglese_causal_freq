---
title: "Causalness, frequency, diachrony and the causal-noncausal alternation in Italian and Spanish"
author: "Giulia Mazzola (Newcastle University) and Guglielmo Inglese (Universit√† di Torino)"
date: "February 2025"
output:
  pdf_document: default
  html_document: default
subtitle: "Beta Regression"
---

## Load and prepare data

```{r setup, include=T, warning=FALSE, message=FALSE}
library(tidyverse)
library(kableExtra)

knitr::opts_chunk$set(include=T, echo = T, warning = F, message = F)

#causal and non causal
data<-readxl::read_excel("romance_all_bruciare_clean_new_vnc_final.xlsx")

# only non causal, verbs with categorical selection removed
data2<-readxl::read_excel("romance_noncaus_feb24_filteredverbs_final.xlsx") 


ita<-data2 %>% filter(language=="italian")
es<-data2 %>% filter(language=="spanish")

ita<-ita %>% select(id, coding, meaning, lemma, ita_vnc70, caus_use_joined)

ita<-ita %>% rename(period=ita_vnc70, causalness_degree=caus_use_joined)

es<-es %>% select(id, coding, meaning, lemma, es_vnc70, caus_use_joined)

es<-es %>% rename(period=es_vnc70, causalness_degree=caus_use_joined)

summary_freq_all<-data %>%
  group_by (language, meaning, lemma) %>%
  summarise (n=n()) 

# Summary of the data
summary_freq_all %>%  kbl(booktabs = TRUE, col.names = c("Language", "Meaning", "Lemma", "Count"), caption = "Causal and noncausal uses of Italian and Spanish verbs") %>%
   collapse_rows(column = 1) %>% kable_paper()


```


## Italian data: prepare for Beta Regression

Subset the Italian data to obtain unique combinations of lemma and period. 

 * Step 1: Aggregate data to calculate the proportion of anticausative codings
 
```{r}

ita_agg <- ita %>%
  group_by(lemma, period) %>%
  summarise(
    anticausative_count = sum(coding == "antic"),
    total_count = n(),
    proportion_anticausative = anticausative_count / total_count,
    causalness_degree = first(causalness_degree),
      ) %>%
  ungroup()
```

 * Step 2: Create a lagged causalness_degree variable

```{r}
ita_agg <- ita_agg %>%
  arrange(lemma, period) %>%
  group_by(lemma) %>%
  mutate(causalness_lagged = lag(causalness_degree)) %>%
  ungroup() %>%
  # Remove rows without previous causalness_degree (period 1)
  filter(!is.na(causalness_lagged))
```

 * Step 3: Adjust proportions slightly to avoid exact 0 and 1

```{r}
ita_agg <- ita_agg %>%
  mutate(proportion_adj = (proportion_anticausative * (total_count - 1) + 0.5) / total_count)

ita_agg<-ita_agg %>%
  filter(!is.na(proportion_adj), !is.na(causalness_lagged))

ita_agg <- ita_agg %>%
  mutate(across(5:8, ~ round(.x, 2))) 

```



## Spanish data: prepare for Beta Regression

Subset the Spanish data to obtain unique combinations of lemma and period. 

* Step 1: Aggregate data to calculate the proportion of anticausative codings:


```{r}
es_agg <- es %>%
  group_by(lemma, period) %>%
  summarise(
    anticausative_count = sum(coding == "antic"),
    total_count = n(),
    proportion_anticausative = anticausative_count / total_count,
    causalness_degree = first(causalness_degree),
    ) %>%
  ungroup()

```

* Step 2: Create a lagged causalness_degree variable:

```{r}
es_agg <- es_agg %>%
  arrange(lemma, period) %>%
  group_by(lemma) %>%
  mutate(causalness_lagged = lag(causalness_degree)) %>%
  ungroup() %>%
  # Remove rows without previous causalness_degree (period 1)
  filter(!is.na(causalness_lagged)) 
```

* Step 3:Adjust proportions slightly to avoid exact 0 and 1


```{r }
es_agg <- es_agg %>%
  mutate(proportion_adj = (proportion_anticausative * (total_count - 1) + 0.5) / total_count)

es_agg<-es_agg %>%
  filter(!is.na(proportion_adj), !is.na(causalness_lagged))

es_agg <- es_agg %>%
  mutate(across(5:8, ~ round(.x, 2))) 

```


## Fit the Beta Regression model

* Step 1: join the Italian and Spanish sub-dataset

```{r}

# Add a column to each dataset to distinguish them
italian <- ita_agg %>%
  mutate(language = "Italian")

spanish <- es_agg %>%
  mutate(language = "Spanish")

# Combine the datasets using bind_rows()
join <- bind_rows(italian, spanish)

# View the combined dataset
head(join)


join$language<-as.factor(join$language)

join$lemma<-as.factor(join$lemma)
join$period_cat<-as.factor(join$period)
join$period<-as.factor(join$period)


# If period is actually a sequential (ordered) variable, you can convert it to a numeric variable. 
# This will allow you to model it as a continuous predictor.

join$period <- as.numeric(join$period) 


```

* Step 2: Fit a beta regression model with `mgvc::gam`: *model1* is the maximal model;


```{r}
# Load required libraries
library(mgcv)
library(report)

model1 <- gam(
  proportion_anticausative ~ 
    s(causalness_lagged, by = language, k = 10, bs = "cs", m = 1) + 
    s(period, by = language, k = 5, bs = "cs"),   
  family = betar(link = "logit"),                 
  data = join
)

# Summarize the model
summary(model1)
```

* Step 3: in *model2* and *model3* we remove the interaction terms from *model1*, and use anova to assess whether this significantly affect the model fit (backward model selection). In both cases, removing the interaction term `language` significantly impact the goodness-of-fit (ANOVA is significant). Since it is not possible to remove the interactions, we also do not remove the simple terms. This leads to the conclusion that *model1* is the best fitted model.

```{r}
model2 <- gam(
  proportion_anticausative ~ 
    s(causalness_lagged, k = 10, bs = "cs", m = 1) +      
    s(period, k = 5, bs = "cs"),                         
  family = betar(link = "logit"),
  data = join
)

summary(model2)

anova.gam(model1, model2, test = "Chisq") 
#ANOVA significant=not ok to remove causalness_lagged*language interaction

model3 <- gam(
  proportion_anticausative ~ 
    s(causalness_lagged, by = language, k = 10, bs = "cs", m = 1) + 
    s(period, k = 5, bs = "cs"),   
  family = betar(link = "logit"),                 
  data = join
)

summary(model3)

anova.gam(model1, model3, test = "Chisq") 
# ANOVA significant=not ok to remove period*language interaction
```

*Step 4: Print the results of the model

```{r}
results<-report::report_table(model1)
report::display(results)

```


## Visualise the results

Visualisation of the effect of `causalness_lagged` and `period` of *model1* (now renamed *model*).

```{r}
library(mgcv)
model<-model1

# Incorporate predictions from beta regression to the original dataset
fit <- join %>%
  mutate(fit = predict(model, newdata = join, type = "response"))

ggplot(fit, aes(x = causalness_lagged, y = proportion_anticausative, color = causalness_lagged)) +
  geom_point( alpha = 0.7, color= "#fc8961") +  
  geom_smooth(method = "gam", se = F, aes(group = language), color= "#fc8961", linewidth = 1.2) +  
    facet_wrap(~ language) +  
  labs(
    title = "",
    x = "Lagged Causalness Degree",
    y = "Proportion of Anticausative",
    color = "Lagged Causalness Degree"
  ) +
  ylim(0,1)+
  theme_minimal() +
  theme(legend.position = "bottom")


ggplot(fit, aes(x = period_cat, y = proportion_anticausative)) +
  geom_smooth(aes(y = fit, group = 1), color = "#fc8961", linewidth = 1.2, se=F) +
  facet_wrap(~ language) +
  labs(
    title = "Effect of Time Period on Anticausative Proportion",
    x = "Time Period",
    y = "Proportion of Anticausative"
  ) +
  theme_minimal() +
  ylim(0,1)+
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)
  )


```
 
 
